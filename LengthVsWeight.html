<!DOCTYPE html>
<html>
<head>
  <title>Tree Species Length vs Weight Scatterplots</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.0"></script>
</head>
<body>
  <div style="max-width: 800px; margin: 0 auto;">
    <h2>Tree Species: Length vs Weight</h2>
    <div>
      <label for="speciesSelector">Select Tree Species: </label>
      <select id="speciesSelector" onchange="updateChart()">
        <option value="all">All Species</option>
      </select>
    </div>
    <div style="height: 500px;">
      <canvas id="scatterChart"></canvas>
    </div>
  </div>

  <script>
    // Global variables
    let scatterChart;
    let treeData = [];
    let uniqueSpecies = [];
    
    // Color palette for different species
    const colorPalette = [
      'rgba(255, 99, 132, 0.7)',    // Red
      'rgba(54, 162, 235, 0.7)',    // Blue
      'rgba(255, 206, 86, 0.7)',    // Yellow
      'rgba(75, 192, 192, 0.7)',    // Teal
      'rgba(153, 102, 255, 0.7)',   // Purple
      'rgba(255, 159, 64, 0.7)',    // Orange
      'rgba(199, 199, 199, 0.7)',   // Gray
      'rgba(83, 102, 255, 0.7)',    // Indigo
      'rgba(255, 99, 255, 0.7)',    // Pink
      'rgba(99, 255, 132, 0.7)',    // Light Green
    ];

    async function fetchTreeData() {
      const response = await fetch('https://docs.google.com/spreadsheets/d/1ODeg72-S_gkW9qrclghoTrIRM3M0fkCtp5pWpTYFJdo/gviz/tq?tqx=out:csv');
      const text = await response.text();
      const rows = text.trim().split('\n').map(row => {
        // Handle potential commas within quoted fields
        const matches = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
        return matches.map(m => m.replace(/^"|"$/g, '').trim());
      });
      
      // Skip header row
      const data = [];
      for (const row of rows.slice(1)) {
        if (row.length >= 3) {
          const species = row[0];
          const length = parseInt(row[1], 10);
          const weight = parseFloat(row[2]);
          
          if (!isNaN(length) && !isNaN(weight)) {
            data.push({
              species,
              length,
              weight
            });
            
            if (!uniqueSpecies.includes(species)) {
              uniqueSpecies.push(species);
            }
          }
        }
      }
      
      return data;
    }

    function populateSpeciesDropdown() {
      const dropdown = document.getElementById('speciesSelector');
      uniqueSpecies.forEach(species => {
        const option = document.createElement('option');
        option.value = species;
        option.textContent = species;
        dropdown.appendChild(option);
      });
    }

    function createDatasets(selectedSpecies) {
      const datasets = [];
      
      if (selectedSpecies === 'all') {
        // Create a dataset for each species
        uniqueSpecies.forEach((species, index) => {
          const speciesData = treeData.filter(tree => tree.species === species);
          datasets.push({
            label: species,
            data: speciesData.map(tree => ({ x: tree.length, y: tree.weight })),
            backgroundColor: colorPalette[index % colorPalette.length],
            pointRadius: 6,
            pointHoverRadius: 8
          });
        });
      } else {
        // Create dataset for selected species only
        const speciesData = treeData.filter(tree => tree.species === selectedSpecies);
        datasets.push({
          label: selectedSpecies,
          data: speciesData.map(tree => ({ x: tree.length, y: tree.weight })),
          backgroundColor: colorPalette[0],
          pointRadius: 6,
          pointHoverRadius: 8
        });
      }
      
      return datasets;
    }

    function initializeChart() {
      const ctx = document.getElementById('scatterChart').getContext('2d');
      scatterChart = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: createDatasets('all')
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            zoom: {
              pan: {
                enabled: true,
                mode: 'xy'
              },
              zoom: {
                wheel: {
                  enabled: true
                },
                pinch: {
                  enabled: true
                },
                mode: 'xy'
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const point = context.raw;
                  return `${context.dataset.label}: Length: ${point.x}, Weight: ${point.y}`;
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Length'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Weight'
              }
            }
          }
        }
      });
    }

    function updateChart() {
      const selectedSpecies = document.getElementById('speciesSelector').value;
      scatterChart.data.datasets = createDatasets(selectedSpecies);
      scatterChart.update();
    }

    // Initialize the visualization
    async function initialize() {
      treeData = await fetchTreeData();
      populateSpeciesDropdown();
      initializeChart();
    }

    // Start the process
    initialize();
  </script>
</body>
</html>
